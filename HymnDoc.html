<!DOCTYPE HTML>
<html>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <head>
    <title>Hymnal App</title>
    <link rel="stylesheet" type="text/css" href="/res/styles/docmain.css">
    <link href="/res/styles/prettify.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/res/styles/prettify.js"></script>
  </head>
  <body onload="prettyPrint()">
  <section id="content">
    <nav>
      <ul>
        <li id="logo">hymnal project</li>
        <li class="menuitem" id="home"><a href="/">home</a></li>
        <li class="menuitem" id="hymns"><a href="/hymns.html">hymns</a></li>
        <li class="menuitem" id="projects"><a href="/projects.html">projects</a></li>
        <li class="menuitem" id="about"><a href="/about.html">about</a></li>
      </ul>
      <br><br>
    </nav>
    <ul id="sidebar">
      <li class="sidemenu" id="1">Scraping the site</li>
      <li class="sidemenu" id="2">Parsing into JSON</li>
      <li class="sidemenu" id="3">Creating the Server</li>
      <li class="sidemenu" id="4">Making the app</li>
      <li class="sidemenu" id="5">Adding Search</li>
    </ul>
    <h1>Lessons Learned: Designing an Android App</h1>
    <p>Web browsing on smartphones is often a time-consuming, eye-wrenching thumb exercise. Through this app, I intended to make it much easier for people to view what they actually wanted - the contents of a song from a website. I was hoping that idea could eventually be applied to other websites (see the <a href="/about.html">about page</a> for more details), but I soon realized that I wouldn't even be able to put this app up in the Android market because of copyright reasons. That's why this app is now only available to friends and family.</p>
    <p>That lack of foresight characterized this whole project, but I'm glad I went through it. My first large-scale project taught me a lot, and hopefully this page will help me remember what I learned.</p>
    <p>Even though the reach of the app is limited, I still believe in its basic premises, and I'm sure that anyone with the same idea and background that I have will find some help in what I learned in its making. The following saga is a chronological rehashing of the steps I took in developing a simple app.</p>
    <h2 id="step1">Scraping the Site</h2>
      <p>Originally, the files from <a href="http://hymnal.net" target="_blank">hymnal.net</a> consisted of simple web pages containing the desired content, the lyrics, in <code>&lt;ol&gt;</code> and <code>&lt;li&gt;</code> tags. I managed to get an archived version of the website, and you can view the source code that I was working with in <a href="/res/examples/hymnalnetarchive.txt" target="_blank">this archive link</a>. It's pretty tough to sort through all of that source code, since it also contains some metadata from the Wayback Machine where I got the archive, but searching for the <code>div</code> tag labeled "lyrics" will give you the content I was after.</p>
      <p>The HTML has since changed, and you can compare the HTML of interest from Hymn 100 when I parsed it to the current state of the site at <a href="view-source:http://www.hymnal.net/hymn.php/h/100" target="_blank">http://www.hymnal.net/hymn.php/h/100</a>.
      </p>
      <pre><div class="code">
<span class ="source">Source: Archive of http://www.hymnal.net/hymn.php/h/100</span>
...
&lt;div id="lyrics"&gt;
&lt;ol&gt;&lt;li value="1"&gt;The Maker of the universe&lt;br/&gt;As Man, for man was made a curse.&lt;br/&gt;The claims of law which He had made,&lt;br/&gt;Unto the uttermost He paid.&lt;/li&gt;&lt;li value="2"&gt;His holy fingers made the bough
...
      </div></pre>
      <p> Grabbing the content of these pages was straightforward, once I knew roughly what the structure of the website was. I controlled the downloading of songs with a simple loop that kept track of which number it had reached, resetting the URL every time, and sticking the number at the end of the URL each time another song was downloaded.
      </p>
      <pre><div class="code">
<span class="source">Source: parse.py</span>
...
from urllib.request import urlopen
web_page = urlopen(url)
  file = open(filename, 'w')
  parser.feed(web_page.read().decode('utf-8'))
...
      </div></pre>
      <p>Behind the scenes, I had two classes that did much of the work. The point was that I didn’t want all of the extra stuff in the HTML page, only the lyrics. I began with the default package with which Python 3 ships, importing the <code>HTMLParser</code> class from <code>html.parser</code> and overriding most of its functions.
      </p>
      <pre><div class="code" id="code">
<span class="source">Source: site1.py</span>
from html.parser import HTMLParser

class HymnHTMLParser(HTMLParser):
  def __init__(self, tagging, want_tag, start_on=None):
    HTMLParser.__init__(self)
    self.recording = 0
    self.data = []
    self.want_tag = want_tag
    self.tagging = tagging
    self.start_on = start_on
    
  def handle_starttag(self, tag, attribute):
    if (self.start_on and
        tag == self.start_on[0]):
      for name, value in attribute:
        if (name == self.start_on[1] and
            value == self.start_on[2]):
          self.tagging = True
    if (self.tagging and
        tag in self.want_tag):
      for name, value in attribute:
        self.data.append(str(value) + ': ')
      self.recording += 1

...

  def handle_entityref(self, name):
    if self.tagging:
      if name == 'mdash':
        self.data.append(str('-'))
      elif name != 'nbsp':
        logging.info(name)

...

  def handle_data(self, data):
    if self.recording:
      self.data.append(data)
      </div></pre>
      <p>Obviously, there were a lot of details in this implementation that I would rather not have kept track of, including errant HTML characters and entities, with all of the problems with encoding. I thought my needs were basic enough that I could handle this project with this simple class, but when I ran into errors with broken HTML, I finally made the switch to <a href="http://www.crummy.com/software/BeautifulSoup/" target="_blank">BeautifulSoup</a>. This switch simplified a lot of things, including handling of the entities and malformed HTML, so I could focus on grabbing the structure and content of the document.
      </p>
      <p>Why did I need a second site parser? Well, obviously I hadn’t made my <code>HymnHTMLParser</code> very extensible, and though I made some misguided attempts to do so (see the <code>want_tag</code> and <code>start_on</code> variables I introduced in an effort to make my code reusable), they were not going to cut it for any other web pages, as I soon realized.
      </p>
      <p>Once I saw that many of the hymns on hymnal.net did not actually contain the lyrics, but instead placeholder text and a link to an external site, I realized I’d need another parser for these other sites. I made simple, hacky check for these links by checking <code>if line[:4] == 'http':</code> each time I got a line from the song. Then, I switched control of parsing to the function in the other class, by calling <code>site2.parse_html(line, file)</code> and changing a flag, <code>parsed</code>, that let the original parser know that the other function had taken care of all the parsing.
      </p>
      <pre><div class="code">
<span class="source">Source: site2.py</span>
from bs4 import BeautifulSoup
from urllib.request import urlopen
from string import punctuation
import util

def parse_url(url):
  soup = BeautifulSoup(urlopen(url).read().decode('utf-8'))
  def filt(tag):
    return (tag.name == ‘font’ and
      tag.has_key(‘class’) and
      tag.parent.parent.parent.name == ‘table’ and
      tag.parent.parent.parent.has_key(‘width’) and
      (tag.parent.parent.parent[‘width’] in [‘400’, ‘500’] or
       tag.parent.parent.parent[‘width’] == ‘760’ and tag[‘class’] == [‘text2’]))
    
  soup = BeautifulSoup(str(soup.find_all(filt)))
  return util.replace_unicode(soup.text)
...
      </div></pre>
      <p>That simplified the code for parsing the second site from which I needed lyrics, though it’s clear from my giant filter statement that it still involved quite a bit of staring at the patterns in the pages to figure out what content I should scrape. I also didn’t know how to handle the Unicode characters that cropped up in my soup, so I just looked up their equivalents (I spent a lot of time looking at <a href="http://webdesign.about.com/od/localization/l/blhtmlcodes-ascii.htm" target="_blank">this reference table for encoding characters</a>) and replaced them.</p>
      <pre><div class="code">
<span class="source">Source: util.py</span>
def replace_unicode(s):
  unicode_chars = {'\xa0': " ", 
            '\x91': "'", 
            '\x92': "'", 
            '\x20\x20': "\\n", 
            '\x20': " ", 
            '\x93': '\"', 
            '\x94': '\"', 
            ",,": "", 
            '\n, ': '\\n', 
            ' Chorus\n,\n,': 'chorus:'}
  for char in unicode_chars:
    s = s.replace(char, unicode_chars[char])
  return s
      </div></pre>
    <h2 id="step2">Parsing into JSON</h2>
      <p>I wanted my application to have as lightweight a footprint on the network as possible, and JSON seemed like the ideal choice. I didn’t put much research into using the built-in module for this in Python 3, resulting in a headache of string-parsing that left me an expert at parsing strings in Python 3 (as wonderful an experience as parsing strings can be because of Python’s useful library of functions) without regular expressions (which I had and have not yet mastered) but used a lot of time that could have been avoided.
      </p>
      <p>JSON took me a little while to learn, since I wasn’t familiar with Javascript before this project. I wasn’t clear that there are two different types: 1) JSON objects and 2) JSON arrays. There are good libraries for dealing with both, and they’re both highly compatible with other languages, including Java and Python. 
      </p>
      <p>The basic format for a JSON Object looks like this:</p>
      <pre><div class="code">
{ “Toyota”: “Prius”, “Honda”: “Accord”, “Hyundai”: “Sonata”,
... }
        </div></pre>
      <p>The basic format for a JSON Array looks like this:</p>
      <pre><div class="code">
[ “Ferrari”, “Porsche”, “Lamborghini”, “Corvette”, 
... ]
      </div></pre>
      <p>The two can be nested within each other, to create more complex structures, like XML, though I didn’t need that for this app. The important difference between objects and arrays, which I didn’t take into account before diving into string parsing, is that JSON arrays are ordered, while JSON objects make no guarantee about which components will be retrieved first.</p>
      <p>I also had to learn how file I/O works in Python, and luckily, this was just as easy. Python will assume you are starting from the directory where your file is if you don’t have an absolute path, so I created a hymns folder that would hold the hymns I was currently downloading. Then, when I was writing my files, I just had to use some simple syntax:</p>
      <pre><div class="code">
file = open(filename, 'w')
file.write(song_text)

# alternatively, you can open a file just for reading.
file = open(filename, 'r')
song_text = file.read()
      </div></pre>
      <p>At this point, also, I became tired of waiting for every song to download once again when I ran my downloader. I added a function in <code>util.py</code> that got all <code>.txt</code> files in the same directory and checked if they were already downloaded before going through the whole ordeal each time.</p>
      <pre><div class="code">
<span class="source">Source: util.py</span>
def get_files_in_directory(directory):
  import os
  dirList = os.listdir(directory)
  files = []
  for d in dirList:
    if d[len(d) - 3: len(d)] == 'txt':
      files.append(d)
  return files
      </div></pre>
      <pre><div class="code">
<span class="source">Source: run.py</span>
filenames = util.get_files_in_directory('./hymns') 

def run(song_type, start_song, end_song):

...

    # open file and replace symbols
    if filename not in filenames:
      parse.parse(url, filename, parser)
      </div></pre>
      <p>In the end, with two different sites that I had to turn into a uniform JSON format, I resorted to a pretty reliable, but low-level method. I looped through every letter in all 1,885 songs, adding formatting where I needed it. </p>
      <p>First, I set up a container string for my resulting JSON. I went through the original string, letter by letter. I checked the letters and words around it to see if I needed to add any special characters to the container string. Whether I did or didn’t, I would add the letter from the original string into the container string, preserving all of its content.</p>
      <p>I began my attempt by outputting some JSON-object formatted songs. </p>
      <pre><div class="code">
<span class="source">Source: util.py</span>
def jsonify(s):
  """ Takes a string of the format
  
  [TAG]: Song words
  Song words
  Song words
  [TAG]: Song words
  Song words
  Song words
  ...
  
  and turns it into a JSON object of the format
  {"[TAG]": "Song words
  Song words
  Song words",
  "[TAG]": "Song words
  Song words
  Song words",
  ...}
  
  """
  TAGS = ['chorus', 'nonum', 'note', 'copyright']

  song_s = '{"'
  for i in range(len(s)):
  for word in TAGS:
    if (s[i - 1] == '\n' and s[i: i + len(word) + 1] == word + ':' or
        s[i] == ':' and s[i - len(word): i] == word):
      song_s += '"'
    if (s[i - 1] == '\n' and is_numeric(s[i]) or
        s[i] == ':' and is_numeric(s[i - 1]) or 
        s[i - 1] == ' ' and s[i - 2] == ':'):
      song_s += '"'
    elif  (s[i] == '\n' and
          (is_numeric(s[i + 1]) or
           s[i + 1] == 'c' or
           s[i + 1] == 'n')):
      song_s += '",'
    if not (i == len(s) - 2 and s[i] == '\n'):
      song_s += s[i]
  return song_s + '"}'
      </div></pre>
      <p>It’s not pretty, but it worked. Comparing the structure of the strings that I began with (see the docstring in the beginning of the above function) to the format I needed for a JSON object (see the code above for that), I was basically adding some <code>“</code>, <code>{}</code>, and the occasional <code>,</code> to the strings where they were needed.</p>
      <p>I had JSON objects, but once I started downloading them from the Android application, I was horrified to find that they had no apparent order. Plus, I realized that those pesky line breaks had unescaped themselves when I put them on the website and sent them through the Internet, resulting in <a href="http://jsonlint.com/" target="_blank">invalid JSON</a>. (It’s not supposed to be broken by line breaks.) It was time to convert them into valid JSON arrays.</p>
      <pre><div class="code">
<span class="source">Source: jobjToArray.py</span>
def run(directory):
  """ Takes a JSON object of the format
    
  {"[TAG]": "Song words
  Song words
  Song words",
  "[TAG]": "Song words
  Song words
  Song words",
  ...}
  
  and turns it into a JSON array of the format
  
  ["[TAG]: Song words
  Song words
  Song words",
  "[TAG]: Song words
  Song words
  Song words",
  ...]
  
  """
  TAGS = ['non', 'cho', 'not', 'cop', ', "']
  import util
  files = util.get_files_in_directory(directory)
  for f in files:
    song_text = open(directory + f, 'r').read()

    # The following line escapes the line breaks
    song_text = (song_text.replace('": "', ' ')
                          .replace('{', '[')
                          .replace('}', ']')
                          .replace('\n', '\\n')
                          .replace('",\\n"', '", "'))
    new_file = open(directory + f, 'w')
    for i in range(len(song_text)):
      if (song_text[i] == '"' 
          and song_text[i + 1: i + 4] not in TAGS and
          not util.is_numeric(song_text[i + 1]) and
          song_text[i + 1] != ']'):
        new_file.write('\\"')
      else:
        try:
          new_file.write(song_text[i])
        except: #index of out bounds due to song_text[i + 1]
          pass # done with file, nothing to do
      </div></pre>
      <p>Finally, all I had to do was add the line <code>jobjToArray.run('./hymns/')</code> to the end of my <code>run.py</code> file to ensure that from now on, I’d be downloading JSON arrays.</p>
      <p>After this rickety attempt to download 1,885 hymns, I was understandably unsure about the quality of my JSON. As you can see above, I realized that validating it would be important if I wanted to be able to use it in my Java application. I couldn’t find an API for any JSON validators (though <a href="http://www.freeformatter.com/json-validator.html" target="_blank">freeformatter</a> came close with its check for websites), so I looked it up and found a fun method: batch scripting. </p>
      <p>This is the simple script I used, using the tips from <a href="http://www.commandlinefu.com/commands/view/2144/validate-and-pretty-print-json-expressions." target="_blank">this really helpful scripting site</a>:</p>
      <pre><div class="code">
<span class="source">Source: validator.bat</span>
@ECHO OFF
FOR %%x IN (*.txt) DO (
    ECHO %%x>>json.log
    CAT %%x | python -m json.tool 1>nul 2>>json.log)
      </div></pre>
      <p>For those interested, this batch script loops through each text file, <code>%%x</code>, in the current directory, feeding its contents to the Python <code>json.tool</code> module, which checks for valid JSON. It echoes <code>stdoutput1</code> to <code>NUL</code> because I wasn’t interested in the files that didn’t cause errors, and <code>stdoutput2</code> went to an error file, <code>json.log</code>, which I could browse for all my files, finding those that were not valid JSON. </p>
      <p>I had a pretty good success rate: about 20 files were empty, which I’m going to assume was a result of some kind of problem with the network connection created by the Python <code>urllib</code> module, because this is a recurring problem that seems to be some kind of timeout mechanism that stops me from downloading thousands of files too quickly. I had errors in parsing about 6 files. These were just unforeseen formats that wouldn’t take too long fix.</p>
    <h2 id="step3">Creating the Server</h2>
      <p>The final step in building the backend for the app was to create a <a href="http://rest.elkstein.org/2008/02/what-is-rest.html" target="_blank">RESTful</a> API for my hymns, so that they could be downloaded from client devices. I went with <a href="http://nodejs.org/">Node.js</a> after a little bit of deliberation. Though small, it is a growing platform, and all of the students I knew at Berkeley had used it for their apps.</p>
      <p>I began with the <a href="http://www.nodebeginner.org/" target="_blank">Node Beginner</a> tutorial, which is probably the best application development tutorial I’ve come across in all my surfing, though that may be because I have almost exactly the same background that the author describes in his opening.</p>
      <p>The basic design of the backend consists of four parts: a router (<code>router.js</code>), request handler (<code>requestHandlers.js</code>), server (<code>server.js</code>), and main component (<code>app.js</code>). These four parts use some slick message passing to pull off a site that is easily extensible.</p>
      <p>The main component starts the server off, passing a route function and <code>handle</code> dictionary composed of functions exported from the request handlers to the server. When a request to the site is received, it triggers the callback to <code>onRequest</code> in <code>server.js</code>. The server parses the query, and calls the route function that was passed from the main component, passing it the <code>handle</code> dictionary, along with the parsed query. The router uses the <code>handle</code> dictionary to find the correct reqeust handler, and then calls it on the query. The request handlers do most of the actual work: they perform the response to the requests received.</p>
      <p>The key in all of this is the callbacks and message passing, which allow non-blocking operations and flexibility. The following diagram traces the path of function calls and message passing.</p>
      <img src="res/images/nodejs.png">
      <p>For now, we'll start with a basic walkthrough of the components to get a site up and running. It all begins with the app component, which imports functions from the other three components and calls the start function from the server, passing it the handlers and router.</p>
      <pre><div class="code">
<span class="source">Source: app.js</span>
var server = require('./server');
var router = require('./router');
var requestHandlers = require('./requestHandlers');

var handle = {};
handle["/"] = requestHandlers.start;
handle["/start"] = requestHandlers.start;
handle["/hymn"] = requestHandlers.serveHymn;
handle["file"] = requestHandlers.serveFile;

server.start(router.route, handle);
      </div></pre>
      <p>If you're used to programming in languages like Java and Python (though Python can also pass functions around), as I was, you might notice that the structure of the <code>start</code> function in the server file is interesting. Besides parsing the query string, the starting function contains the definition of another function, <code>onRequest</code>, which is passed as the argument to the <code>createServer</code> function.</p>
      <pre><div class="code">
<span class="source">Source: server.js</span>
var http = require("http");
var url = require("url");

function start(route, handle) {
  function onRequest (request, response) {
    var pathname = url.parse(request.url).pathname;
    var query = url.parse(request.url).query;
    console.log("Request for " + pathname + " received");
    route(handle, pathname, response, query);
  }
  http.createServer(onRequest).listen(process.env.VMC_APP_PORT || 1337, null);
  console.log("Server has started");
}

exports.start = start;
      </div></pre>
      <p>This callback, a common occurrence in Javascript, is a function passed as an argument to the other, to be executed later within the function to which it was passed. Although all of the code in the function is executed in order, one thing after another, seemingly odd sequences of events can sometimes occur in Javascript code. But that's what makes the language so asynchronous.</p>
      <p>For example, those logging statements that I placed at the bottom of the functions will be displayed immediately after I run them, even if the page has not loaded completely yet. Try it yourself and see.</p>
      <p>From there, the router simply had to choose the correct function to display the webpage that was requested. At this point, I was concerned only with the function that would serve the JSON hymns I had put on the website.</p>
      <pre><div class="code">
<span class="source">Source: requestHandlers.js</span>
var fs = require('fs');
var querystring = require('querystring');
var mime = require('mime');

function serveHymn(response, query, pathname) {
  var file = "./hymns/" + querystring.parse(query).type + "/hymn" + querystring.parse(query).hymn + ".txt";
  console.log("FILE " + file);
  fs.readFile(file, function(error, content) {
    write(error, content, response, query, mime.lookup(file));
  });
}

exports.serveHymn = serveHymn;
      </div></pre>
      <p>I had a lot more work to do before the site became as developed as it is now (all I had was a HelloWorld page and <a href="http://hymn.aws.af.cm/hymn?hymn=5&type=ns" target="_blank">some ugly JSON strings I could use in my app</a>), but I didn't work on anything else for the website at that point, so I'll describe the rest of its development, when I decided to display the app's documentation, later.</p>
      <p>(Note: the structure of this website is somewhat influenced by the requirements of the hosting service that I chose to use, <a href="http://appfog.com" target="_blank">Appfog</a>. Each hosting service will require the starting component, in this case, <code>app.js</code>, to be named a certain way, and you need to set an environment variable in starting the server. But that's about it. You can either upload the code to a website of your own or test the app by opening command prompt and running <code>node app.js</code> and checking localhost:1337.)</p>
    <h2 id="step4">Making the App</h2>
      <p>Finally, I could begin with my original goal: creating an Android app!</p>
      <p>My shaky background with Java had convinced me to put this part of the project off, but when I began, I realized that I had learned so much over the semester that it was just a matter of reading the <a href="http://developer.android.com/index.html" target="_blank">Android Documentation</a> for more information on how specific components worked.</p>
      <p>In any case, my initial plan was for the app to receive a search query, perform a search, and retreive the appropriate results and songs from the backend that I described above. It was a simple plan, but in hindsight, it required a lot more planning than I initally did.</p>
      <p>The first working version of the app kept it as simple as possible. I expected users to input a URL into an EditText field, and used an AsyncTask to perform the downloading work. After turning the JSON response into an ArrayList, I used a CursorAdapter to populate the result into a ListView, which was the song that was displayed.</p>
      <p>Those are the details of the implementation, but how I arrived at it is descibed below.</p>
      <p>I'll give a general overview of my understanding of the Android development system. Creating an app is composed of several steps, including editing an XML layout file, and Java classes that perform the logic of the app. The default beginning for an app includes a MainActivity class, which extends Activity, which, in Android, is often another name for a view.</p>
      <p>The activity lifecycle is managed by the operating system, and the <code>onCreate</code> method generated in the MainActivity class is the one that is automatically called when the app opens. You usually have to set your view to the one that matches the Activity in this method, although that's not required if the Activity is a background activity, since users don't need to know what's going on behind the scenes for some activities.</p>
      <pre><div class="code">
<span class="source">Source: MainActivity.java</span>
public class MainActivity extends Activity {
  @Override
  public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    
    ...
      </div></pre>
      <p>Developing an app in Android, I found out later, is a little like developing a webapp with Javascript, but without the perks of <a href="http://jquery.com/">jQuery</a>. You select items from the XML layout file (analogous to the HTML document for websites) and abstract them as objects to manipulate them with Java (like in Javascript).</p>
      <p>Then, for buttons, you set an <code>onClickListener</code> on the button. My button extracts the user input from the EditText box and sends it to a new method, the <code>execute</code> function of the <code>DownloadTask</code> class.</p>
      <pre><div class="code">
<span class="source">Source: MainActivity.java</span>
    ...
    
    Button btnDownload = (Button) findViewById(R.id.btn_download);
    
    OnClickListener downloadListener = new OnClickListener() {
      public void onClick(View v) {
        if (isNetworkAvailable()) {
          EditText etUrl = (EditText) findViewById(R.id.et_url);
          DownloadTask downloadTask = new DownloadTask();
          downloadTask.execute(etUrl.getText().toString());
        } else {
          Toast.makeText(getBaseContext(), "Network is not available", Toast.LENGTH_SHORT).show();
        }
      }
    };
    btnDownload.setOnClickListener(downloadListener);
  }
      
      ...
      </div></pre>
      <p>The <code>DownloadTask</code> class extends the <code>AyncTask</code> class, which is an easy way to put asynchronous tasks into UI threads without blocking the updating of the UI. It's an alternative to using a Thread. I had to override two functions inside the task, the <code>doInBackground</code> method and the <code>onPostExecute</code> method. There are also useful functions for updating a dialog box, among other things.</p>
      <p>The background downloading task calls the <code>downloadUrl</code> function, which checks if the song has already been downloaded, in which case it will have been saved as a file in the Android system already, and it simply retrieves that file. Otherwise, it uses an HttpUrlConnection to grab the song from the web backend. The byte stream is converted to a string by the function <code>convertStream</code>.</p>
      <pre><div class="code">
<span class="source">Source: MainActivity.java</span>
  private String downloadUrl(String strUrl) throws IOException {
    InputStream iStream = null;
    String song = null;
    if (inArray(fileList(), parseUrl(strUrl))){
      Log.d("IO", "File found in cache");
      iStream = openFileInput(parseUrl(strUrl));
      song = convertStream(iStream).toString();
    } else{
      try {
        URL url = new URL(strUrl);
        HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection();
        urlConnection.connect();
        iStream = urlConnection.getInputStream();
        song = convertStream(iStream).toString();
      } catch(Exception e) {
        Log.d("Exception while downloading url", e.toString());
      }
    }
    return song;
  }
      </div></pre>
      <p>After the background task is executed, the <code>onPostExecute</code> function saves the string so that it won't have to be downloaded the next time. (Something I realized during this documentation: it does the saving whether the file was there already or not, something that needs to change. I guess documentation really does help).</p>
      <p>Finally, the function passes control of the app from the <code>MainActivity</code> class to the other class in the app, the <code>HymnList</code> class, passing an extra variable, the song, with the <code>Intent</code>.</p>
      <pre><div class="code">
<span class="source">Source: MainActivity.java</span>
  private class DownloadTask extends AsyncTask<String, Integer, String> {
    String json = null;
    @Override
    protected String doInBackground(String... url) {
      try {
        json = downloadUrl(url[0]);
      } catch(Exception e) {
        Log.d("Background task", e.toString());
      }
      return json;
    }
    @Override
    protected void onPostExecute(String result) {
      ArrayList<String> stanza = null;
      JSONArray jArray = null;
      FileOutputStream songSaver = null;
      String url = null;
      if (result == null){
        Toast.makeText(getBaseContext(), "Invalid song selection", Toast.LENGTH_SHORT).show();
      } else{
        try {
          jArray = new JSONArray(result);
          stanza = jsonToArrayList(jArray);
        } catch (JSONException e) {
          Toast.makeText(getBaseContext(), "Error downloading song", Toast.LENGTH_SHORT).show();
        }
        try {
          url = parseUrl(((EditText) findViewById(R.id.et_url)).getText().toString());
          songSaver = openFileOutput(url, Context.MODE_PRIVATE);
        } catch (FileNotFoundException e) {
          e.printStackTrace();
        }
        try {
          songSaver.write(result.getBytes());
          songSaver.close();
        } catch (IOException e) {
          e.printStackTrace();
        }
        Intent show_song = new Intent(getBaseContext(), HymnList.class);
        show_song.putExtra("song", stanza);
        startActivity(show_song);
      }
    }
  }
      </div></pre>
      <p>The <code>HymnList</code> class put the contents of the Array into an <code>ArrayAdapter</code>, so that it would be easy to place the resulting hymn into the <code>ListView</code> that the class consisted of. The use of a ListView allowed for dyanmic creation and scrolling of the JSON format.</p>
      <pre><div class="code">
<span class="source">Source: HymnList.java</span>
  public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
        setContentView(R.layout.list);
        
    Intent song = getIntent();
    String[] songArray = song.getStringArrayExtra("song");
    ArrayAdapter<String> adapter = new ArrayAdapter<String>(this, R.layout.list_item, songArray);
    ListView songList = (ListView) findViewById(R.id.songList);
    songList.setSelector(android.R.color.transparent); // No dividers between song verses
    songList.setAdapter(adapter);
  }
      </div></pre>
      <p>Inside the XML files for the class, I simply declared a <code>ListView</code> inside <code>HymnList.java</code>and inflated it with <code>list_item.xml</code> as list items. I made it simple, with each list item simply being a <code>TextView</code> that would contain the song's verse.</p>
      <pre><div class="code">
<span class="source">Source: list.xml</span>
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical" &gt;
    &lt;ListView
        android:id="@+id/songList"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:divider="@null"
    android:dividerHeight="0dp"
    /&gt;
&lt;/LinearLayout&gt;
      </div></pre>
      <pre><div class="code">
<span class="source">Source: list_item.xml</span>
&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;TextView xmlns:android="http://schemas.android.com/apk/res/android"
    android:id="@+id/list_item"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent"
    android:padding="5dip" &gt;
&lt;/TextView&gt;
      </div></pre>
      <p>The above code was good enough for a basic implementation of the hymnal application, which accomplished the goals that I was after from the very beginning. There were still a lot of problems - users had to insert URLs into the text box to directly grab the hymn, so they would have to know my API. By extension, there was no search function.</p>
      <p>I did a lot more work on the app before it became as developed as it is now, but having done so, I don't feel the need to recount every detail of its implementation. It's sufficient to know that Android application programming is much more tedious that I could have imagined, but that's an understandable attitude, having come from Python to Java.</p>
      <p>Instead, I'll recount the lessons I learned from my first full-scale development of an app on someone else's framework.</p>
      <ul>
        <li class="body"><b>Use packages developed by others that are meant to make the job easier.</b> I didn't know it was possible, but after developing the app, I found out that many libraries are out there for Android development. A good understanding of what's going on behind the scenes is still required, but there is a lot of boilerplate code that can easily be taken care of. Eclipse development makes it pretty painless, but Java is no slouch at creating code. Some libraries that looked helpful to me: </li>
        <ul>
          <li class="body"><a href="http://code.google.com/p/roboguice/" target="_blank">RoboGuice</a> - Get rid of initializing and dealing with all those variables at the beginning of functions by injecting them.</li>
          <li class="body"><a href="http://actionbarsherlock.com/" target="_blank">ActionBarSherlock</a> - Maintain compatibility with Android before 3.0 even in applications using the Action Bar. Also make it easier to work with the Action Bar.</li>
        </ul>
        <li class="body"><b>Make sure to decide how you're going to be passing your data around before you begin.</b>This is a broad, all-encompassing piece of advice. This includes deciding whether to use the Internet to store your information, or a database. This includes how you will access that information, and how you will organize it. I ended up creating a class of objects to manage my <code>Songs</code>, which, in Java programming is probably the best way to go. I only wish I had done it earlier.</li>
        <li class="body"><b>Learn how to read the Android docs.</b> This is pretty self-explanatory. During my development, my code went from about 90 percent copy-pasted to about 5 percent.</li>
      </ul>
    <h2 id="step4">Adding Search</h2>
      <p>At this point, to make my app actually usuable, I had to consider how I would add search. The <a href="http://developer.android.com/training/search/search.html" target="_blank">Android docs</a> encourage developers to make use of <a href="http://www.sqlite.org/fts3.html">SQLite's full-text search capability</a>. (That SQLite documentation, by the way, is highly worth reading.)</p>
      <p>This would require me to go back to Python to do some scripting, so that I could move all the data I'd gathered into a database. It wasn't too difficult, with the help of <a href="http://zetcode.com/db/sqlitepythontutorial/" target="_blank">this tutorial</a>, though I had to wrap my mind around what a cursor was.</p>
      <p>Once again, I brought out the <code>getFiles</code> directory from the old project, and used Python's SQLite library to add it to a new database.</p>
      <pre><div class="code">
<span class="source">Source: songDatabaser.py</span>
con = sqlite3.connect(SONG_DB)
with con:
  cur = con.cursor()
  for f in get_files('./'):
      song_text = open(f, 'r').read()
      song_num = SONG_TYPE.replace('\\', '') + f[4:].replace('.txt', '')

      if song_num in dict_sheets:
          cur.execute("INSERT INTO songs VALUES(NULL, ?, ?, ?);", 
                      (song_num, song_text, dict_sheets[song_num]))
      else:
          cur.execute("INSERT INTO songs VALUES(NULL, ?, ?, ?);", 
                      (song_num, song_text, ''))</span>
      </div></pre>
      <p>I had quite a scare when I realized that there was no support for FTS tables in Python's SQLite library. I thought my SQLite might be out of date, so I deleted it. I had to find the right replacement at <a href="http://www.lfd.uci.edu/~gohlke/pythonlibs/" target="_blank">UCI's python library</a>.</p>
      <p>Putting each song into the database was now a matter of copying and pasting the script into each hymn directory, then running the script.</p>
      <p> I learned a few useful commands for working with Android databases along the way. The first set of commands set up the table schema so that my databasing script would work.</p>
      <ul>
        <li class="body"><code>CREATE TABLE songs(_id PRIMARY INTEGER KEY AUTOINCREMENT, url TEXT, song TEXT);</code> - You need the _id table so that Android knows how the cursor is ordered for adapters.</li>
        <li class="body"><code>CREATE TABLE android_metadata(locale TEXT DEFAULT 'en_us');</code></li>
        <li class="body"><code>INSERT INTO android_metadata VALUES('en_us');</code> - Metadata for Android, again</li>
      </ul>
      <p>The second set of commands was the hacky way of getting around Python's incompatibility with FTS tables - creating a new FTS table with the same schema as the original, adding everything from old one, and then dropping the old one.</p>
      <ul>
        <li class="body"><code>CREATE VIRTUAL TABLE songdb USING FTS3(_id PRIMARY INTEGER KEY AUTOINCREMENT, url TEXT, song TEXT);</code></li>
        <li class="body"><code>INSERT INTO songdb SELECT * FROM songs;</code></li>
        <li class="body"><code>DROP TABLE songs;</code></li>
      </ul>
      <p>Querying the resulting database was a simple matter of taking advantage of the <code>MATCH</code> selection that is unique to FTS tables. In my app, I also used the <code>SNIPPET</code> function so that I could retreive only the relevant parts of the songs that matched the queries. Hopefully, someday, I'll have an opportunity to implement something with the <code>MATCHINFO</code> function, which seems to present a lot of possibilities.</p>
      <p></p>
    </section>
    <section id="footer">
      <br><br><br><br><br><br><br>
      <hr>
      <ul id="footer">
        <li>&copy; 2012 by Bill Yeh</li>
        <li><a id="footer" href="https://github.com/billyeh" target="_blank">View Source Code at https://github.com/billyeh</a></li>
      </ul>
    </section>
    
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25550561-2']);
  _gaq.push(['_setDomainName', 'aws.af.cm']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script>
    $(document).ready(function() {

      /* Adds sidebar scrolling animation */
      $('.sidemenu').click(function() {
        $('html, body').animate({
          scrollTop: $('#step' + event.target.id).offset().top - 65
          }, 500);
      });

      /* This function adds the logo click to go to home page function */
      $('#logo').click(function () {
        window.open('/', '_self');
      });

      /* This function scrolls the sidebar down the page. */
        var $sidebar   = $('#sidebar'), 
            offset     = $sidebar.offset(),
            topPadding = 100;
        $(window).scroll(function() {
            if ($(window).scrollTop() > offset.top - 100) {
                $sidebar.stop().animate({
                    marginTop: $(window).scrollTop() - offset.top + topPadding
                }, 'slow');
            } else {
                $sidebar.stop().animate({
                    marginTop: 0
                });
            }
        });

        /* Highlighting for menu items */
        var pathname = window.location.pathname;
        if (pathname == '/') {
          $('#home').css('font-weight', 'bold');
        }

        /*Using GoogleCode to prettyprint code snippets*/
        $('pre').addClass('prettyprint');

        /* Adding click function to source tags */
        //There must be an easier way to do this...
        $('.source').click(function() {
          var sourceName = ($(this).text()).slice(8);
          if (sourceName == 'app.js' || 
              sourceName == 'router.js' || 
              sourceName == 'requestHandlers.js' ||
              sourceName == 'server.js') {
            window.open('https://github.com/billyeh/HymnalNodeServe/blob/master/' + sourceName);
          }
          else if (sourceName == 'parse.py' ||
              sourceName == 'site1.py' ||
              sourceName == 'site2.py' ||
              sourceName == 'util.py' ||
              sourceName == 'jobjToArray.py' ||
              sourceName == 'validator.bat') {
            window.open('https://github.com/billyeh/HymnalParse/blob/master/' + sourceName);
          }
          else if (sourceName == 'MainActivity.java' ||
              sourceName == 'HymnList.java') {
            window.open('https://github.com/billyeh/Hymnal/tree/master/src/bill/com/hymnal' + sourceName);
          }
          else if (sourceName == 'list_item.xml' ||
              sourceName == 'list.xml') {
            window.open('https://github.com/billyeh/Hymnal/tree/master/res/layout');
          }
          else if (sourceName == 'songDatabaser.py') {
            window.open('https://github.com/billyeh/HymnalNodeServe/tree/master/res/db' + sourceName);
          }
          else {
            window.open(sourceName);
          }
        });
    });
  </script>
  </body>
</html>